{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Select One Employee Per Task</h2>

    <form method="POST" id="selectionForm">
        {% for task in tasks %}
            <div class="task-container mb-4 p-3 border rounded bg-light">
                <h4 class="mb-3">{{ task }}</h4>
                <div class="row">
                    {% for emp in employees[task] %}
                        <div class="col-md-4">
                            <label class="employee-option w-100 p-3 border rounded d-block employee-label" 
                                   data-emp-id="{{ emp.employee_id }}"
                                   style="cursor: pointer; transition: 0.3s;">
                                <input type="radio" 
                                       name="employee_{{ task }}" 
                                       value="{{ emp.employee_id }}" 
                                       required hidden>
                                <div class="employee-content">
                                    <strong>{{ emp.name }}</strong><br>
                                    Age: {{ emp.age }}<br>
                                    Gender: {{ emp.gender }}
                                </div>
                            </label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
        <div class="text-center">
            <button type="submit" class="btn btn-primary mt-3">Confirm Worker</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const allOptions = document.querySelectorAll(".employee-option");

        // Track selected employee IDs to disable others
        const selectedEmployeeIds = new Set();

        allOptions.forEach(option => {
            const input = option.querySelector("input");
            const empId = option.dataset.empId;

            option.addEventListener("click", () => {
                if (input.disabled) return;

                input.checked = true;

                // Remove selection styles for same group
                const groupName = input.name;
                document.querySelectorAll(`input[name="${groupName}"]`).forEach(inp => {
                    inp.parentElement.classList.remove("bg-success", "text-white");
                    inp.parentElement.classList.remove("employee-selected");
                    selectedEmployeeIds.delete(inp.parentElement.dataset.empId);
                });

                // Mark this one selected
                option.classList.add("bg-success", "text-white", "employee-selected");
                selectedEmployeeIds.add(empId);

                // Disable this employee in other tasks
                allOptions.forEach(opt => {
                    const optInput = opt.querySelector("input");
                    const optEmpId = opt.dataset.empId;

                    if (optEmpId === empId && optInput.name !== groupName) {
                        optInput.disabled = true;
                        opt.classList.add("bg-secondary", "text-white", "employee-disabled");
                        opt.classList.remove("employee-selected");
                    }

                    // Re-enable other employees not selected
                    if (!selectedEmployeeIds.has(optEmpId)) {
                        optInput.disabled = false;
                        opt.classList.remove("bg-secondary", "text-white", "employee-disabled");
                    }
                });
            });
        });
    });
</script>
<style>
    .employee-disabled {
        opacity: 0.6;
        pointer-events: none;
    }

    .employee-selected {
        border: 2px solid #218838 !important;
    }
</style>
{% endblock %}
